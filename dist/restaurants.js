async function storeRestaurantsDb(t){let e=await idb.open("restaurants-db",1,t=>t.createObjectStore("restaurants",{keyPath:"id"})),a=e.transaction("restaurants","readwrite"),r=a.objectStore("restaurants");t.forEach(t=>{r.put(t)}),await a.complete,e.close()}async function storeAllReviews(t){let e=await idb.open("reviews-db",1,t=>t.createObjectStore("reviews",{keyPath:"id"})),a=e.transaction("reviews","readwrite"),r=a.objectStore("reviews");t.forEach(t=>{r.put(t)}),await a.complete,e.close()}async function getAllRestaurants(){let t=await idb.open("restaurants-db",1),e=t.transaction("restaurants","readonly").objectStore("restaurants"),a=await e.getAll();return t.close(),a}async function storeRestaurantsDb(t){let e=await idb.open("restaurants-db",1,t=>t.createObjectStore("restaurants",{keyPath:"id"})),a=e.transaction("restaurants","readwrite"),r=a.objectStore("restaurants");t.forEach(t=>{r.put(t)}),await a.complete,e.close()}async function getAllRestaurants(){let t=await idb.open("restaurants-db",1),e=t.transaction("restaurants","readonly").objectStore("restaurants"),a=await e.getAll();return t.close(),a}async function getAllReviews(){let t=await idb.open("reviews-db",1),e=t.transaction("reviews","readonly").objectStore("reviews"),a=await e.getAll();return t.close(),a}async function updateFavoriteStatus(t,e){await fetch(`http://localhost:1337/restaurants/${t}/?is_favorite=${e}`,{method:"PUT"});const a=await idb.open("restaurants-db",1),r=a.transaction("restaurants","readwrite"),s=r.objectStore("restaurants");s.get(t).then(t=>{t.is_favorite=e,s.put(t)}),await r.complete,a.close()}class DBHelper{static get DATABASE_URL(){return"http://localhost:1337/restaurants"}static get REVIEWDATA_URL(){return"http://localhost:1337/reviews"}static async fetchRestaurants(){const t=await fetch(`${DBHelper.DATABASE_URL}`);if(200===t.status){const e=await t.json();await storeRestaurantsDb(e);const a=await fetch(`${DBHelper.REVIEWDATA_URL}`);if(200!==a.status)throw new Error("Request of reviews has failed");{const t=await a.json();await storeAllReviews(t)}return e}throw new Error("Request of restaurants has failed")}static async fetchRestaurantById(t){await DBHelper.fetchRestaurants().then(t=>{console.log(t)}).catch(t=>{console.log("Error",t)});const e=(await getAllRestaurants()).find(e=>e.id==t);if(e)return e;throw new Error("Restaurant does not exist")}static async fetchRestaurantByNeighborhood(t){const e=await getAllRestaurants();if(e){return e.filter(e=>e.neighborhood==t)}throw new Error("Neigborhood does not exist")}static async fetchRestaurantByCuisineAndNeighborhood(t,e){await DBHelper.fetchRestaurants().then(t=>{console.log(t)}).catch(t=>{console.log("Error",t)});const a=await getAllRestaurants();if(a){let r=a;return"all"!=t&&(r=r.filter(e=>e.cuisine_type==t)),"all"!=e&&(r=r.filter(t=>t.neighborhood==e)),r}throw new Error("Restaurants with cuisine and neighborhood conbination does not exist")}static async fetchNeighborhoods(){await DBHelper.fetchRestaurants().then(t=>{console.log(t)}).catch(t=>{console.log("Error",t)});const t=await getAllRestaurants();if(t){const e=t.map((e,a)=>t[a].neighborhood);return e.filter((t,a)=>e.indexOf(t)==a)}throw new Error("Failed at fetching all neighborhoods")}static async fetchCuisines(){await DBHelper.fetchRestaurants().then(t=>{console.log(t)}).catch(t=>{console.log("Error",t)});const t=await getAllRestaurants();if(t){const e=t.map((e,a)=>t[a].cuisine_type);return e.filter((t,a)=>e.indexOf(t)==a)}throw new Error("Failed at fetching all cuisine")}static urlForRestaurant(t){return`./restaurant.html?id=${t.id}`}static imageUrlForRestaurant(t){return void 0===t.photograph?"/img/error.jpg":`/img/${t.photograph}.jpg`}static imageUrlForRestaurant_responsive(t){return void 0===t.photograph?"img/responsive_img/error":`img/responsive_img/${t.id}`}static mapMarkerForRestaurant(t,e){return new google.maps.Marker({position:t.latlng,title:t.name,url:DBHelper.urlForRestaurant(t),map:e,animation:google.maps.Animation.DROP})}}
let restaurants,neighborhoods,cuisines;var map,markers=[];navigator.serviceWorker?navigator.serviceWorker.register("./service-worker.js",{scope:"./"}).then(function(e){console.log("ServiceWorker Register")}).catch(function(e){console.log("error"),console.error(e)}):console.log("ServiceWorker not supported."),document.addEventListener("DOMContentLoaded",async e=>{await fetchNeighborhoods(),fetchCuisines()}),fetchNeighborhoods=(()=>{DBHelper.fetchNeighborhoods(neighborhoods).then(e=>{self.neighborhoods=e,fillNeighborhoodsHTML()}).catch(e=>{console.log(e)})}),fillNeighborhoodsHTML=((e=self.neighborhoods)=>{const t=document.getElementById("neighborhoods-select");e.forEach(e=>{const s=document.createElement("option");s.innerHTML=e,s.value=e,t.append(s)})}),fetchCuisines=(e=>{DBHelper.fetchCuisines(e).then(e=>{self.cuisines=e,fillCuisinesHTML()}).catch(e=>{console.log(e)})}),fillCuisinesHTML=((e=self.cuisines)=>{const t=document.getElementById("cuisines-select");e.forEach(e=>{const s=document.createElement("option");s.innerHTML=e,s.value=e,t.append(s)})}),window.initMap=(()=>{self.map=new google.maps.Map(document.getElementById("map"),{zoom:12,center:{lat:40.722216,lng:-73.987501},scrollwheel:!1}),updateRestaurants()}),updateRestaurants=(()=>{const e=document.getElementById("cuisines-select"),t=document.getElementById("neighborhoods-select"),s=e.selectedIndex,n=t.selectedIndex,o=e[s].value,r=t[n].value;DBHelper.fetchRestaurantByCuisineAndNeighborhood(o,r).then(e=>{resetRestaurants(e),fillRestaurantsHTML()}).catch(e=>{console.log(e)})}),resetRestaurants=(e=>{self.restaurants=[],document.getElementById("restaurants-list").innerHTML="",self.markers.forEach(e=>e.setMap(null)),self.markers=[],self.restaurants=e}),fillRestaurantsHTML=((e=self.restaurants)=>{const t=document.getElementById("restaurants-list");e.forEach(e=>{t.append(createRestaurantHTML(e))}),addMarkersToMap()}),createRestaurantHTML=(e=>{const t=document.createElement("li"),s=DBHelper.imageUrlForRestaurant_responsive(e),n=document.createElement("figure"),o=document.createElement("picture"),r=document.createElement("source"),a=document.createElement("source"),i=document.createElement("img"),c=document.createElement("figcaption");r.setAttribute("media","(min-width: 501px)"),r.setAttribute("srcset",`${s}_large_2x.jpg 2x, ${s}_large_1x.jpg`),a.setAttribute("media","(max-width: 500px)"),a.setAttribute("srcset",`${s}_small_2x.jpg 2x, ${s}_small_1x.jpg`),i.className="restaurant-img",i.src=DBHelper.imageUrlForRestaurant(e),i.setAttribute("alt",e.name),c.textContent=e.name,n.append(o),n.append(c),o.append(r),o.append(a),o.append(i),t.append(n);const l=document.createElement("h1");l.innerHTML=e.name,t.append(l);const d=document.createElement("button");d.innerHTML="&hearts;",d.classList.add("isFavorite"),"true"===e.is_favorite|!0===e.is_favorite?(d.classList.add("yesFav"),console.log(`Status for ${e.id} is true ad type is ${typeof e.is_favorite}`)):"false"===e.is_favorite|!1===e.is_favorite&&(d.classList.remove("yesFav"),console.log(`Status for ${e.id} is false ad type is ${typeof e.is_favorite}`)),d.onclick=(()=>{d.classList.toggle("yesFav");const t=!JSON.parse(e.is_favorite);console.log(t),updateFavoriteStatus(e.id,t),e.is_favorite=t,console.log(e.is_favorite)}),t.append(d);const u=document.createElement("p");u.innerHTML=e.neighborhood,t.append(u);const p=document.createElement("p");p.innerHTML=e.address,t.append(p);const m=document.createElement("a");return m.innerHTML="View Details",m.href=DBHelper.urlForRestaurant(e),t.append(m),t}),addMarkersToMap=((e=self.restaurants)=>{e.forEach(e=>{const t=DBHelper.mapMarkerForRestaurant(e,self.map);google.maps.event.addListener(t,"click",()=>{window.location.href=t.url}),self.markers.push(t)})});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRiaGVscGVyLmpzIiwibWFpbi5qcyJdLCJuYW1lcyI6WyJhc3luYyIsInN0b3JlUmVzdGF1cmFudHNEYiIsInJlc3RhdXJhbnRzIiwiZGIiLCJpZGIiLCJvcGVuIiwidXBncmFkZURCIiwiY3JlYXRlT2JqZWN0U3RvcmUiLCJrZXlQYXRoIiwidHgiLCJ0cmFuc2FjdGlvbiIsInN0b3JlIiwib2JqZWN0U3RvcmUiLCJmb3JFYWNoIiwicmVzdGF1cmFudCIsInB1dCIsImNvbXBsZXRlIiwiY2xvc2UiLCJzdG9yZUFsbFJldmlld3MiLCJyZXZpZXdzIiwicmV2aWV3IiwiZ2V0QWxsUmVzdGF1cmFudHMiLCJhbGxTYXZlZEl0ZW1zIiwiZ2V0QWxsIiwiZ2V0QWxsUmV2aWV3cyIsInVwZGF0ZUZhdm9yaXRlU3RhdHVzIiwicmVzdGF1cmFudElkIiwiZmF2b3JpdGVTdGF0dXMiLCJmZXRjaCIsIm1ldGhvZCIsImdldCIsInRoZW4iLCJyZXN0dXJhbnQiLCJpc19mYXZvcml0ZSIsIkRCSGVscGVyIiwiREFUQUJBU0VfVVJMIiwiUkVWSUVXREFUQV9VUkwiLCJbb2JqZWN0IE9iamVjdF0iLCJyZXN0YXVyYW50UmVzcG9uc2UiLCJzdGF0dXMiLCJqc29uIiwicmV2aWV3UmVzcG9uc2UiLCJFcnJvciIsImlkIiwiZmV0Y2hSZXN0YXVyYW50cyIsImNvbnNvbGUiLCJsb2ciLCJjYXRjaCIsImVyciIsImZpbmQiLCJyIiwibmVpZ2hib3Job29kIiwiZmlsdGVyIiwiY3Vpc2luZSIsInJlc3VsdHMiLCJjdWlzaW5lX3R5cGUiLCJuZWlnaGJvcmhvb2RzIiwibWFwIiwidiIsImkiLCJpbmRleE9mIiwiY3Vpc2luZXMiLCJ1bmRlZmluZWQiLCJwaG90b2dyYXBoIiwiZ29vZ2xlIiwibWFwcyIsIk1hcmtlciIsInBvc2l0aW9uIiwibGF0bG5nIiwidGl0bGUiLCJuYW1lIiwidXJsIiwidXJsRm9yUmVzdGF1cmFudCIsImFuaW1hdGlvbiIsIkFuaW1hdGlvbiIsIkRST1AiLCJtYXJrZXJzIiwibmF2aWdhdG9yIiwic2VydmljZVdvcmtlciIsInJlZ2lzdGVyIiwic2NvcGUiLCJyZWdpc3RyYXRpb24iLCJlIiwiZXJyb3IiLCJkb2N1bWVudCIsImFkZEV2ZW50TGlzdGVuZXIiLCJldmVudCIsImZldGNoTmVpZ2hib3Job29kcyIsImZldGNoQ3Vpc2luZXMiLCJzZWxmIiwiZmlsbE5laWdoYm9yaG9vZHNIVE1MIiwic2VsZWN0IiwiZ2V0RWxlbWVudEJ5SWQiLCJvcHRpb24iLCJjcmVhdGVFbGVtZW50IiwiaW5uZXJIVE1MIiwidmFsdWUiLCJhcHBlbmQiLCJyZXN1dGxzIiwiZmlsbEN1aXNpbmVzSFRNTCIsIndpbmRvdyIsImluaXRNYXAiLCJNYXAiLCJ6b29tIiwiY2VudGVyIiwibGF0IiwibG5nIiwic2Nyb2xsd2hlZWwiLCJ1cGRhdGVSZXN0YXVyYW50cyIsImNTZWxlY3QiLCJuU2VsZWN0IiwiY0luZGV4Iiwic2VsZWN0ZWRJbmRleCIsIm5JbmRleCIsImZldGNoUmVzdGF1cmFudEJ5Q3Vpc2luZUFuZE5laWdoYm9yaG9vZCIsInJlc2V0UmVzdGF1cmFudHMiLCJmaWxsUmVzdGF1cmFudHNIVE1MIiwibSIsInNldE1hcCIsInVsIiwiY3JlYXRlUmVzdGF1cmFudEhUTUwiLCJhZGRNYXJrZXJzVG9NYXAiLCJsaSIsImltYWdlSUQiLCJpbWFnZVVybEZvclJlc3RhdXJhbnRfcmVzcG9uc2l2ZSIsImZpZ3VyZSIsInBpY3R1cmUiLCJzb3VyY2VMYXJnZSIsInNvdXJjZVNtYWxsIiwiaW1hZ2UiLCJmaWdDYXB0aW9uIiwic2V0QXR0cmlidXRlIiwiY2xhc3NOYW1lIiwic3JjIiwiaW1hZ2VVcmxGb3JSZXN0YXVyYW50IiwidGV4dENvbnRlbnQiLCJpc0Zhdm9yaXRlIiwiY2xhc3NMaXN0IiwiYWRkIiwicmVtb3ZlIiwib25jbGljayIsInRvZ2dsZSIsImN1cnJlbnRGYXZTdGF0dXMiLCJKU09OIiwicGFyc2UiLCJhZGRyZXNzIiwibW9yZSIsImhyZWYiLCJtYXJrZXIiLCJtYXBN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bUgsdUJBQXVCdkksRUFBWTJFLEtBQUtoQyxLQUNoRU8sT0FBT0MsS0FBS3FCLE1BQU1nRSxZQUFZRixFQUFRLFFBQVMsS0FDN0NoRCxPQUFPbUQsU0FBU0osS0FBT0MsRUFBTzdFLE1BRWhDa0IsS0FBS2IsUUFBUTRFLEtBQUtKIiwiZmlsZSI6InJlc3RhdXJhbnRzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiYXN5bmMgZnVuY3Rpb24gc3RvcmVSZXN0YXVyYW50c0RiKHJlc3RhdXJhbnRzKSB7XG4gIGxldCBkYiA9IGF3YWl0IGlkYi5vcGVuKCdyZXN0YXVyYW50cy1kYicsIDEsIHVwZ3JhZGVEQiA9PiB1cGdyYWRlREIuY3JlYXRlT2JqZWN0U3RvcmUoJ3Jlc3RhdXJhbnRzJywge1xuICAgIGtleVBhdGg6ICdpZCdcbiAgfSkpXG5cbiAgbGV0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ3Jlc3RhdXJhbnRzJywgJ3JlYWR3cml0ZScpXG4gIGxldCBzdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdyZXN0YXVyYW50cycpXG5cbiAgcmVzdGF1cmFudHMuZm9yRWFjaChyZXN0YXVyYW50ID0+IHtcbiAgICBzdG9yZS5wdXQocmVzdGF1cmFudClcbiAgfSk7XG5cbiAgYXdhaXQgdHguY29tcGxldGVcbiAgZGIuY2xvc2UoKVxufVxuXG5hc3luYyBmdW5jdGlvbiBzdG9yZUFsbFJldmlld3MocmV2aWV3cykge1xuICBsZXQgZGIgPSBhd2FpdCBpZGIub3BlbigncmV2aWV3cy1kYicsIDEsIHVwZ3JhZGVEQiA9PiB1cGdyYWRlREIuY3JlYXRlT2JqZWN0U3RvcmUoJ3Jldmlld3MnLCB7XG4gICAga2V5UGF0aDogJ2lkJ1xuICB9KSlcblxuICBsZXQgdHggPSBkYi50cmFuc2FjdGlvbigncmV2aWV3cycsICdyZWFkd3JpdGUnKVxuICBsZXQgc3RvcmUgPSB0eC5vYmplY3RTdG9yZSgncmV2aWV3cycpXG5cbiAgcmV2aWV3cy5mb3JFYWNoKHJldmlldyA9PiB7XG4gICAgc3RvcmUucHV0KHJldmlldylcbiAgfSk7XG5cbiAgYXdhaXQgdHguY29tcGxldGVcbiAgZGIuY2xvc2UoKVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBbGxSZXN0YXVyYW50cygpIHtcbiAgbGV0IGRiID0gYXdhaXQgaWRiLm9wZW4oJ3Jlc3RhdXJhbnRzLWRiJywgMSlcblxuICBsZXQgdHggPSBkYi50cmFuc2FjdGlvbigncmVzdGF1cmFudHMnLCAncmVhZG9ubHknKVxuICBsZXQgc3RvcmUgPSB0eC5vYmplY3RTdG9yZSgncmVzdGF1cmFudHMnKVxuXG4gIGxldCBhbGxTYXZlZEl0ZW1zID0gYXdhaXQgc3RvcmUuZ2V0QWxsKClcblxuICBkYi5jbG9zZSgpXG5cbiAgcmV0dXJuIGFsbFNhdmVkSXRlbXNcbn1hc3luYyBmdW5jdGlvbiBzdG9yZVJlc3RhdXJhbnRzRGIocmVzdGF1cmFudHMpIHtcbiAgbGV0IGRiID0gYXdhaXQgaWRiLm9wZW4oJ3Jlc3RhdXJhbnRzLWRiJywgMSwgdXBncmFkZURCID0+IHVwZ3JhZGVEQi5jcmVhdGVPYmplY3RTdG9yZSgncmVzdGF1cmFudHMnLCB7XG4gICAga2V5UGF0aDogJ2lkJ1xuICB9KSlcblxuICBsZXQgdHggPSBkYi50cmFuc2FjdGlvbigncmVzdGF1cmFudHMnLCAncmVhZHdyaXRlJylcbiAgbGV0IHN0b3JlID0gdHgub2JqZWN0U3RvcmUoJ3Jlc3RhdXJhbnRzJylcblxuICByZXN0YXVyYW50cy5mb3JFYWNoKHJlc3RhdXJhbnQgPT4ge1xuICAgIHN0b3JlLnB1dChyZXN0YXVyYW50KVxuICB9KTtcblxuICBhd2FpdCB0eC5jb21wbGV0ZVxuICBkYi5jbG9zZSgpXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFsbFJlc3RhdXJhbnRzKCkge1xuICBsZXQgZGIgPSBhd2FpdCBpZGIub3BlbigncmVzdGF1cmFudHMtZGInLCAxKVxuXG4gIGxldCB0eCA9IGRiLnRyYW5zYWN0aW9uKCdyZXN0YXVyYW50cycsICdyZWFkb25seScpXG4gIGxldCBzdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdyZXN0YXVyYW50cycpXG5cbiAgbGV0IGFsbFNhdmVkSXRlbXMgPSBhd2FpdCBzdG9yZS5nZXRBbGwoKVxuXG4gIGRiLmNsb3NlKClcblxuICByZXR1cm4gYWxsU2F2ZWRJdGVtc1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBbGxSZXZpZXdzKCkge1xuICBsZXQgZGIgPSBhd2FpdCBpZGIub3BlbigncmV2aWV3cy1kYicsIDEpXG5cbiAgbGV0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ3Jldmlld3MnLCAncmVhZG9ubHknKVxuICBsZXQgc3RvcmUgPSB0eC5vYmplY3RTdG9yZSgncmV2aWV3cycpXG5cbiAgbGV0IGFsbFNhdmVkSXRlbXMgPSBhd2FpdCBzdG9yZS5nZXRBbGwoKVxuXG4gIGRiLmNsb3NlKClcblxuICByZXR1cm4gYWxsU2F2ZWRJdGVtc1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVGYXZvcml0ZVN0YXR1cyhyZXN0YXVyYW50SWQsIGZhdm9yaXRlU3RhdHVzKSB7XG4gIGF3YWl0IGZldGNoKGBodHRwOi8vbG9jYWxob3N0OjEzMzcvcmVzdGF1cmFudHMvJHtyZXN0YXVyYW50SWR9Lz9pc19mYXZvcml0ZT0ke2Zhdm9yaXRlU3RhdHVzfWAsIHtcbiAgICBtZXRob2Q6ICdQVVQnXG4gIH0pO1xuXG4gIGNvbnN0IGRiID0gYXdhaXQgaWRiLm9wZW4oJ3Jlc3RhdXJhbnRzLWRiJywgMSk7XG4gIGNvbnN0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ3Jlc3RhdXJhbnRzJywgJ3JlYWR3cml0ZScpO1xuICBjb25zdCBzdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdyZXN0YXVyYW50cycpO1xuXG4gIHN0b3JlLmdldChyZXN0YXVyYW50SWQpXG4gICAgLnRoZW4ocmVzdHVyYW50ID0+IHtcbiAgICAgIHJlc3R1cmFudC5pc19mYXZvcml0ZSA9IGZhdm9yaXRlU3RhdHVzO1xuICAgICAgc3RvcmUucHV0KHJlc3R1cmFudCk7XG4gICAgfSk7XG5cbiAgYXdhaXQgdHguY29tcGxldGU7XG4gIGRiLmNsb3NlKCk7XG59XG5cbmNsYXNzIERCSGVscGVyIHtcblxuICAvKipcbiAgICogRGF0YWJhc2UgVVJMLlxuICAgKiBDaGFuZ2UgdGhpcyB0byByZXN0YXVyYW50cy5qc29uIGZpbGUgbG9jYXRpb24gb24geW91ciBzZXJ2ZXIuXG4gICAqL1xuICBzdGF0aWMgZ2V0IERBVEFCQVNFX1VSTCgpIHtcbiAgICBjb25zdCBwb3J0ID0gMTMzNyAvLyBDaGFuZ2UgdGhpcyB0byB5b3VyIHNlcnZlciBwb3J0XG4gICAgcmV0dXJuIGBodHRwOi8vbG9jYWxob3N0OiR7cG9ydH0vcmVzdGF1cmFudHNgO1xuICB9XG5cbiAgc3RhdGljIGdldCBSRVZJRVdEQVRBX1VSTCgpIHtcbiAgICBjb25zdCBwb3J0ID0gMTMzNyAvLyBDaGFuZ2UgdGhpcyB0byB5b3VyIHNlcnZlciBwb3J0XG4gICAgcmV0dXJuIGBodHRwOi8vbG9jYWxob3N0OiR7cG9ydH0vcmV2aWV3c2A7XG4gIH1cblxuICAvKipcbiAgICogRmV0Y2ggYWxsIHJlc3RhdXJhbnRzLlxuICAgKiBXT1JLSU5HXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZmV0Y2hSZXN0YXVyYW50cygpIHtcbiAgICAvLyBGZXRjaCByZXN0dXJhbnRzIGRhdGEgYmFzZVxuICAgIGNvbnN0IHJlc3RhdXJhbnRSZXNwb25zZSA9IGF3YWl0IGZldGNoKGAke0RCSGVscGVyLkRBVEFCQVNFX1VSTH1gKVxuXG4gICAgaWYgKHJlc3RhdXJhbnRSZXNwb25zZS5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgY29uc3QgcmVzdGF1cmFudHMgPSBhd2FpdCByZXN0YXVyYW50UmVzcG9uc2UuanNvbigpXG4gICAgICAvLyBzdG9yZSByZXN0YXVyYW50IGRhdGEgYmFzZSBpbnRvIEluZGV4ZWREQlxuICAgICAgYXdhaXQgc3RvcmVSZXN0YXVyYW50c0RiKHJlc3RhdXJhbnRzKVxuICAgICAgLy8gZmV0Y2ggYW5kIHN0b3JlIGFsbCByZXZpZXdzXG4gICAgICBjb25zdCByZXZpZXdSZXNwb25zZSA9IGF3YWl0IGZldGNoKGAke0RCSGVscGVyLlJFVklFV0RBVEFfVVJMfWApXG5cbiAgICAgIGlmIChyZXZpZXdSZXNwb25zZS5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICBjb25zdCByZXZpZXdzID0gYXdhaXQgcmV2aWV3UmVzcG9uc2UuanNvbigpXG4gICAgICAgIGF3YWl0IHN0b3JlQWxsUmV2aWV3cyhyZXZpZXdzKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IG9mIHJldmlld3MgaGFzIGZhaWxlZCcpXG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdGF1cmFudHNcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IG9mIHJlc3RhdXJhbnRzIGhhcyBmYWlsZWQnKVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBGZXRjaCBhIHJlc3RhdXJhbnQgYnkgaXRzIElELlxuICAgKiBXT1JLSU5HXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZmV0Y2hSZXN0YXVyYW50QnlJZChpZCkge1xuXG4gICAgYXdhaXQgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50cygpLnRoZW4oKHJlc3RhdXJhbnRzKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhyZXN0YXVyYW50cylcbiAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZygnRXJyb3InLCBlcnIpO1xuICAgIH0pXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzIGZyb20gSW5kZXhlZERCXG4gICAgY29uc3QgcmVzdGF1cmFudHMgPSBhd2FpdCBnZXRBbGxSZXN0YXVyYW50cygpXG4gICAgY29uc3QgcmVzdGF1cmFudCA9IHJlc3RhdXJhbnRzLmZpbmQociA9PiByLmlkID09IGlkKVxuICAgIGlmIChyZXN0YXVyYW50KSB7XG4gICAgICByZXR1cm4gcmVzdGF1cmFudFxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Jlc3RhdXJhbnQgZG9lcyBub3QgZXhpc3QnKVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIGN1aXNpbmUgdHlwZSB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cbiAgICogV09SS0lOR1xuICAgKi9cbiAgc3RhdGljIGFzeW5jIGZldGNoUmVzdGF1cmFudEJ5TmVpZ2hib3Job29kKG5laWdoYm9yaG9vZCkge1xuXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzIGZyb20gSW5kZXhlZERCXG4gICAgY29uc3QgcmVzdGF1cmFudHMgPSBhd2FpdCBnZXRBbGxSZXN0YXVyYW50cygpO1xuXG4gICAgaWYgKHJlc3RhdXJhbnRzKSB7XG4gICAgICBjb25zdCByZXN1bHRzID0gcmVzdGF1cmFudHMuZmlsdGVyKHIgPT4gci5uZWlnaGJvcmhvb2QgPT0gbmVpZ2hib3Job29kKTtcbiAgICAgIHJldHVybiByZXN1bHRzXG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTmVpZ2Jvcmhvb2QgZG9lcyBub3QgZXhpc3QnKVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIGN1aXNpbmUgYW5kIGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxuICAgKiBXT1JLSU5HXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lQW5kTmVpZ2hib3Job29kKGN1aXNpbmUsIG5laWdoYm9yaG9vZCkge1xuICAgIGF3YWl0IERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKS50aGVuKChyZXN0YXVyYW50cykgPT4ge1xuICAgICAgY29uc29sZS5sb2cocmVzdGF1cmFudHMpXG4gICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ0Vycm9yJywgZXJyKTtcbiAgICB9KVxuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50cyBmcm9tIEluZGV4ZWREQlxuICAgIGNvbnN0IHJlc3RhdXJhbnRzID0gYXdhaXQgZ2V0QWxsUmVzdGF1cmFudHMoKTtcblxuICAgIGlmIChyZXN0YXVyYW50cykge1xuICAgICAgbGV0IHJlc3VsdHMgPSByZXN0YXVyYW50c1xuICAgICAgaWYgKGN1aXNpbmUgIT0gJ2FsbCcpIHsgLy8gZmlsdGVyIGJ5IGN1aXNpbmVcbiAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5jdWlzaW5lX3R5cGUgPT0gY3Vpc2luZSk7XG4gICAgICB9XG4gICAgICBpZiAobmVpZ2hib3Job29kICE9ICdhbGwnKSB7IC8vIGZpbHRlciBieSBuZWlnaGJvcmhvb2RcbiAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5uZWlnaGJvcmhvb2QgPT0gbmVpZ2hib3Job29kKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlc3VsdHNcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXN0YXVyYW50cyB3aXRoIGN1aXNpbmUgYW5kIG5laWdoYm9yaG9vZCBjb25iaW5hdGlvbiBkb2VzIG5vdCBleGlzdCcpXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEZldGNoIGFsbCBuZWlnaGJvcmhvb2RzIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxuICAgKiBXT1JLSU5HXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZmV0Y2hOZWlnaGJvcmhvb2RzKCkge1xuICAgIGF3YWl0IERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKS50aGVuKChyZXN0YXVyYW50cykgPT4ge1xuICAgICAgY29uc29sZS5sb2cocmVzdGF1cmFudHMpXG4gICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ0Vycm9yJywgZXJyKTtcbiAgICB9KVxuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50cyBmcm9tIEluZGV4ZWREQlxuICAgIGNvbnN0IHJlc3RhdXJhbnRzID0gYXdhaXQgZ2V0QWxsUmVzdGF1cmFudHMoKTtcblxuICAgIGlmIChyZXN0YXVyYW50cykge1xuICAgICAgLy8gR2V0IGFsbCBuZWlnaGJvcmhvb2RzIGZyb20gYWxsIHJlc3RhdXJhbnRzXG4gICAgICBjb25zdCBuZWlnaGJvcmhvb2RzID0gcmVzdGF1cmFudHMubWFwKCh2LCBpKSA9PiByZXN0YXVyYW50c1tpXS5uZWlnaGJvcmhvb2QpXG4gICAgICAvLyBSZW1vdmUgZHVwbGljYXRlcyBmcm9tIG5laWdoYm9yaG9vZHNcbiAgICAgIGNvbnN0IHVuaXF1ZU5laWdoYm9yaG9vZHMgPSBuZWlnaGJvcmhvb2RzLmZpbHRlcigodiwgaSkgPT4gbmVpZ2hib3Job29kcy5pbmRleE9mKHYpID09IGkpXG5cbiAgICAgIHJldHVybiB1bmlxdWVOZWlnaGJvcmhvb2RzXG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIGF0IGZldGNoaW5nIGFsbCBuZWlnaGJvcmhvb2RzJylcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRmV0Y2ggYWxsIGN1aXNpbmVzIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGZldGNoQ3Vpc2luZXMoKSB7XG4gICAgYXdhaXQgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50cygpLnRoZW4oKHJlc3RhdXJhbnRzKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhyZXN0YXVyYW50cylcbiAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZygnRXJyb3InLCBlcnIpO1xuICAgIH0pXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzIGZyb20gSW5kZXhlZERCXG4gICAgY29uc3QgcmVzdGF1cmFudHMgPSBhd2FpdCBnZXRBbGxSZXN0YXVyYW50cygpO1xuXG4gICAgaWYgKHJlc3RhdXJhbnRzKSB7XG4gICAgICBjb25zdCBjdWlzaW5lcyA9IHJlc3RhdXJhbnRzLm1hcCgodiwgaSkgPT4gcmVzdGF1cmFudHNbaV0uY3Vpc2luZV90eXBlKVxuICAgICAgLy8gUmVtb3ZlIGR1cGxpY2F0ZXMgZnJvbSBjdWlzaW5lc1xuICAgICAgY29uc3QgdW5pcXVlQ3Vpc2luZXMgPSBjdWlzaW5lcy5maWx0ZXIoKHYsIGkpID0+IGN1aXNpbmVzLmluZGV4T2YodikgPT0gaSlcblxuICAgICAgcmV0dXJuIHVuaXF1ZUN1aXNpbmVzXG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIGF0IGZldGNoaW5nIGFsbCBjdWlzaW5lJylcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVzdGF1cmFudCBwYWdlIFVSTC5cbiAgICovXG4gIHN0YXRpYyB1cmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpIHtcbiAgICByZXR1cm4gKGAuL3Jlc3RhdXJhbnQuaHRtbD9pZD0ke3Jlc3RhdXJhbnQuaWR9YCk7XG4gIH1cblxuICAvKipcbiAgICogUmVzdGF1cmFudCBpbWFnZSBVUkwuXG4gICAqIEVycm9yIGNoZWNraW5nIGR1ZSB0byByZXN0YXVyYW50ICMxMCBkb2VzIG5vdCBoYXZlIGEgcGhvdG8gcHJvcGVydHlcbiAgICovXG4gIHN0YXRpYyBpbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCkge1xuICAgIGNvbnN0IHBob3RvID0gcmVzdGF1cmFudC5waG90b2dyYXBoO1xuXG4gICAgaWYgKHBob3RvID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiAoYC9pbWcvZXJyb3IuanBnYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAoYC9pbWcvJHtyZXN0YXVyYW50LnBob3RvZ3JhcGh9LmpwZ2ApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNwb25zaXZlIGltYWdlIG9ubHkgZ2V0cyB0aGUgbmFtZSBvZiB0aGUgcGljdHVyZSBieSBpZCB3aWhvdXQgZ2V0dGluZyB0aGUgZXh0ZW5zaW9uLCBleHRlbnNpb24gd2lsbCBiZSBhZGRlZCBpbiBsYXRlclxuICAgKiBFcnJvciBjaGVja2luZyBkdWUgdG8gcmVzdGF1cmFudCAjMTAgZG9lcyBub3QgaGF2ZSBhIHBob3RvIHByb3BlcnR5XG4gICAqL1xuICBzdGF0aWMgaW1hZ2VVcmxGb3JSZXN0YXVyYW50X3Jlc3BvbnNpdmUocmVzdGF1cmFudCkge1xuXG4gICAgY29uc3QgcGhvdG8gPSByZXN0YXVyYW50LnBob3RvZ3JhcGg7XG5cbiAgICBpZiAocGhvdG8gPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIChgaW1nL3Jlc3BvbnNpdmVfaW1nL2Vycm9yYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAoYGltZy9yZXNwb25zaXZlX2ltZy8ke3Jlc3RhdXJhbnQuaWR9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIE1hcCBtYXJrZXIgZm9yIGEgcmVzdGF1cmFudC5cbiAgICovXG4gIHN0YXRpYyBtYXBNYXJrZXJGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQsIG1hcCkge1xuICAgIGNvbnN0IG1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoe1xuICAgICAgcG9zaXRpb246IHJlc3RhdXJhbnQubGF0bG5nLFxuICAgICAgdGl0bGU6IHJlc3RhdXJhbnQubmFtZSxcbiAgICAgIHVybDogREJIZWxwZXIudXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSxcbiAgICAgIG1hcDogbWFwLFxuICAgICAgYW5pbWF0aW9uOiBnb29nbGUubWFwcy5BbmltYXRpb24uRFJPUFxuICAgIH0pO1xuICAgIHJldHVybiBtYXJrZXI7XG4gIH1cbn1cblxuLy8gYXN5bmMgKCkgPT4ge1xuLy8gTWFrZXMgaW5pdGlhbCBmZXRjaCByZXF1ZXN0IGFuZCBzYXZlcyBpdCBpbnRvIEluZGV4ZWREQlxuLy8gICBhd2FpdCBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKCkudGhlbigocmVzdGF1cmFudHMpID0+e1xuLy8gICAgIGNvbnNvbGUubG9nKHJlc3RhdXJhbnRzKVxuLy8gICB9KS5jYXRjaCgoZXJyKSA9Pntcbi8vICAgICBjb25zb2xlLmxvZygnRXJyb3InLCBlcnIpO1xuLy8gICB9KVxuLy8gfSIsImxldCByZXN0YXVyYW50cyxcbiAgbmVpZ2hib3Job29kcyxcbiAgY3Vpc2luZXNcbnZhciBtYXBcbnZhciBtYXJrZXJzID0gW11cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gQ2hlY2tpbmcgaWYgU2VydmljZSBXb3JrZXIgaXMgYXZhaWJsZVxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuaWYgKG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyKSB7XG4gIG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLnJlZ2lzdGVyKCcuL3NlcnZpY2Utd29ya2VyLmpzJywge1xuICAgICAgc2NvcGU6ICcuLydcbiAgICB9KVxuICAgIC50aGVuKGZ1bmN0aW9uIChyZWdpc3RyYXRpb24pIHtcbiAgICAgIGNvbnNvbGUubG9nKCdTZXJ2aWNlV29ya2VyIFJlZ2lzdGVyJyk7XG4gICAgfSlcbiAgICAuY2F0Y2goZnVuY3Rpb24gKGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdlcnJvcicpXG4gICAgICBjb25zb2xlLmVycm9yKGUpO1xuICAgIH0pXG59IGVsc2Uge1xuICBjb25zb2xlLmxvZygnU2VydmljZVdvcmtlciBub3Qgc3VwcG9ydGVkLicpO1xufVxuXG4vKipcbiAqIEZldGNoIG5laWdoYm9yaG9vZHMgYW5kIGN1aXNpbmVzIGFzIHNvb24gYXMgdGhlIHBhZ2UgaXMgbG9hZGVkLlxuICovXG5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgYXN5bmMgKGV2ZW50KSA9PiB7XG4gIGF3YWl0IGZldGNoTmVpZ2hib3Job29kcygpO1xuICBmZXRjaEN1aXNpbmVzKCk7XG59KTtcblxuLyoqXG4gKiBGZXRjaCBhbGwgbmVpZ2hib3Job29kcyBhbmQgc2V0IHRoZWlyIEhUTUwuXG4gKi9cbmZldGNoTmVpZ2hib3Job29kcyA9ICgpID0+IHtcbiAgLy8gRE9ORVxuICBEQkhlbHBlci5mZXRjaE5laWdoYm9yaG9vZHMobmVpZ2hib3Job29kcylcbiAgICAudGhlbigocmVzdWx0cykgPT4ge1xuICAgICAgc2VsZi5uZWlnaGJvcmhvb2RzID0gcmVzdWx0cztcbiAgICAgIGZpbGxOZWlnaGJvcmhvb2RzSFRNTCgpO1xuICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgfSlcbn1cblxuLyoqXG4gKiBTZXQgbmVpZ2hib3Job29kcyBIVE1MLlxuICovXG5maWxsTmVpZ2hib3Job29kc0hUTUwgPSAobmVpZ2hib3Job29kcyA9IHNlbGYubmVpZ2hib3Job29kcykgPT4ge1xuICBjb25zdCBzZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbmVpZ2hib3Job29kcy1zZWxlY3QnKTtcbiAgbmVpZ2hib3Job29kcy5mb3JFYWNoKG5laWdoYm9yaG9vZCA9PiB7XG4gICAgY29uc3Qgb3B0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJyk7XG4gICAgb3B0aW9uLmlubmVySFRNTCA9IG5laWdoYm9yaG9vZDtcbiAgICBvcHRpb24udmFsdWUgPSBuZWlnaGJvcmhvb2Q7XG4gICAgc2VsZWN0LmFwcGVuZChvcHRpb24pO1xuICB9KTtcbn1cblxuLyoqXG4gKiBGZXRjaCBhbGwgY3Vpc2luZXMgYW5kIHNldCB0aGVpciBIVE1MLlxuICovXG5mZXRjaEN1aXNpbmVzID0gKGN1aXNpbmVzKSA9PiB7XG4gIC8vIERPTkVcbiAgREJIZWxwZXIuZmV0Y2hDdWlzaW5lcyhjdWlzaW5lcylcbiAgICAudGhlbigocmVzdXRscykgPT4ge1xuICAgICAgc2VsZi5jdWlzaW5lcyA9IHJlc3V0bHM7XG4gICAgICBmaWxsQ3Vpc2luZXNIVE1MKCk7XG4gICAgfSlcbiAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICB9KVxufVxuXG4vKipcbiAqIFNldCBjdWlzaW5lcyBIVE1MLlxuICovXG5maWxsQ3Vpc2luZXNIVE1MID0gKGN1aXNpbmVzID0gc2VsZi5jdWlzaW5lcykgPT4ge1xuICBjb25zdCBzZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY3Vpc2luZXMtc2VsZWN0Jyk7XG5cbiAgY3Vpc2luZXMuZm9yRWFjaChjdWlzaW5lID0+IHtcbiAgICBjb25zdCBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRpb24nKTtcbiAgICBvcHRpb24uaW5uZXJIVE1MID0gY3Vpc2luZTtcbiAgICBvcHRpb24udmFsdWUgPSBjdWlzaW5lO1xuICAgIHNlbGVjdC5hcHBlbmQob3B0aW9uKTtcbiAgfSk7XG59XG5cbi8qKlxuICogSW5pdGlhbGl6ZSBHb29nbGUgbWFwLCBjYWxsZWQgZnJvbSBIVE1MLlxuICovXG53aW5kb3cuaW5pdE1hcCA9ICgpID0+IHtcbiAgbGV0IGxvYyA9IHtcbiAgICBsYXQ6IDQwLjcyMjIxNixcbiAgICBsbmc6IC03My45ODc1MDFcbiAgfTtcbiAgc2VsZi5tYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXAnKSwge1xuICAgIHpvb206IDEyLFxuICAgIGNlbnRlcjogbG9jLFxuICAgIHNjcm9sbHdoZWVsOiBmYWxzZVxuICB9KTtcbiAgdXBkYXRlUmVzdGF1cmFudHMoKTtcbn1cblxuLyoqXG4gKiBVcGRhdGUgcGFnZSBhbmQgbWFwIGZvciBjdXJyZW50IHJlc3RhdXJhbnRzLlxuICovXG51cGRhdGVSZXN0YXVyYW50cyA9ICgpID0+IHtcbiAgY29uc3QgY1NlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdWlzaW5lcy1zZWxlY3QnKTtcbiAgY29uc3QgblNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduZWlnaGJvcmhvb2RzLXNlbGVjdCcpO1xuXG4gIGNvbnN0IGNJbmRleCA9IGNTZWxlY3Quc2VsZWN0ZWRJbmRleDtcbiAgY29uc3QgbkluZGV4ID0gblNlbGVjdC5zZWxlY3RlZEluZGV4O1xuXG4gIGNvbnN0IGN1aXNpbmUgPSBjU2VsZWN0W2NJbmRleF0udmFsdWU7XG4gIGNvbnN0IG5laWdoYm9yaG9vZCA9IG5TZWxlY3RbbkluZGV4XS52YWx1ZTtcbiAgLy8gRE9ORVxuICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QoY3Vpc2luZSwgbmVpZ2hib3Job29kKVxuICAudGhlbigocmVzdWx0cykgPT4ge1xuICAgIHJlc2V0UmVzdGF1cmFudHMocmVzdWx0cyk7XG4gICAgICBmaWxsUmVzdGF1cmFudHNIVE1MKCk7XG4gIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICBjb25zb2xlLmxvZyhlcnIpO1xuICB9KVxufVxuXG4vKipcbiAqIENsZWFyIGN1cnJlbnQgcmVzdGF1cmFudHMsIHRoZWlyIEhUTUwgYW5kIHJlbW92ZSB0aGVpciBtYXAgbWFya2Vycy5cbiAqL1xucmVzZXRSZXN0YXVyYW50cyA9IChyZXN0YXVyYW50cykgPT4ge1xuICAvLyBSZW1vdmUgYWxsIHJlc3RhdXJhbnRzXG4gIHNlbGYucmVzdGF1cmFudHMgPSBbXTtcbiAgY29uc3QgdWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudHMtbGlzdCcpO1xuICB1bC5pbm5lckhUTUwgPSAnJztcblxuICAvLyBSZW1vdmUgYWxsIG1hcCBtYXJrZXJzXG4gIHNlbGYubWFya2Vycy5mb3JFYWNoKG0gPT4gbS5zZXRNYXAobnVsbCkpO1xuICBzZWxmLm1hcmtlcnMgPSBbXTtcbiAgc2VsZi5yZXN0YXVyYW50cyA9IHJlc3RhdXJhbnRzO1xufVxuXG4vKipcbiAqIENyZWF0ZSBhbGwgcmVzdGF1cmFudHMgSFRNTCBhbmQgYWRkIHRoZW0gdG8gdGhlIHdlYnBhZ2UuXG4gKi9cbmZpbGxSZXN0YXVyYW50c0hUTUwgPSAocmVzdGF1cmFudHMgPSBzZWxmLnJlc3RhdXJhbnRzKSA9PiB7XG4gIGNvbnN0IHVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnRzLWxpc3QnKTtcbiAgcmVzdGF1cmFudHMuZm9yRWFjaChyZXN0YXVyYW50ID0+IHtcbiAgICB1bC5hcHBlbmQoY3JlYXRlUmVzdGF1cmFudEhUTUwocmVzdGF1cmFudCkpO1xuICB9KTtcbiAgYWRkTWFya2Vyc1RvTWFwKCk7XG59XG5cbi8qKlxuICogQ3JlYXRlIHJlc3RhdXJhbnQgSFRNTC5cbiAqL1xuY3JlYXRlUmVzdGF1cmFudEhUTUwgPSAocmVzdGF1cmFudCkgPT4ge1xuICBjb25zdCBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7XG5cbiAgY29uc3QgaW1hZ2VJRCA9IERCSGVscGVyLmltYWdlVXJsRm9yUmVzdGF1cmFudF9yZXNwb25zaXZlKHJlc3RhdXJhbnQpO1xuICBjb25zdCBmaWd1cmUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdmaWd1cmUnKTtcbiAgY29uc3QgcGljdHVyZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3BpY3R1cmUnKTtcbiAgY29uc3Qgc291cmNlTGFyZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzb3VyY2UnKTtcbiAgY29uc3Qgc291cmNlU21hbGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzb3VyY2UnKTtcbiAgY29uc3QgaW1hZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTtcbiAgY29uc3QgZmlnQ2FwdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ZpZ2NhcHRpb24nKTtcblxuICBzb3VyY2VMYXJnZS5zZXRBdHRyaWJ1dGUoJ21lZGlhJywgJyhtaW4td2lkdGg6IDUwMXB4KScpO1xuICBzb3VyY2VMYXJnZS5zZXRBdHRyaWJ1dGUoJ3NyY3NldCcsIGAke2ltYWdlSUR9X2xhcmdlXzJ4LmpwZyAyeCwgJHtpbWFnZUlEfV9sYXJnZV8xeC5qcGdgKTtcbiAgc291cmNlU21hbGwuc2V0QXR0cmlidXRlKCdtZWRpYScsICcobWF4LXdpZHRoOiA1MDBweCknKTtcbiAgc291cmNlU21hbGwuc2V0QXR0cmlidXRlKCdzcmNzZXQnLCBgJHtpbWFnZUlEfV9zbWFsbF8yeC5qcGcgMngsICR7aW1hZ2VJRH1fc21hbGxfMXguanBnYCk7XG4gIGltYWdlLmNsYXNzTmFtZSA9ICdyZXN0YXVyYW50LWltZyc7XG4gIGltYWdlLnNyYyA9IERCSGVscGVyLmltYWdlVXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KTtcbiAgaW1hZ2Uuc2V0QXR0cmlidXRlKFwiYWx0XCIsIHJlc3RhdXJhbnQubmFtZSlcbiAgZmlnQ2FwdGlvbi50ZXh0Q29udGVudCA9IHJlc3RhdXJhbnQubmFtZTtcbiAgZmlndXJlLmFwcGVuZChwaWN0dXJlKTtcbiAgZmlndXJlLmFwcGVuZChmaWdDYXB0aW9uKVxuICBwaWN0dXJlLmFwcGVuZChzb3VyY2VMYXJnZSk7XG4gIHBpY3R1cmUuYXBwZW5kKHNvdXJjZVNtYWxsKTtcbiAgcGljdHVyZS5hcHBlbmQoaW1hZ2UpO1xuICBsaS5hcHBlbmQoZmlndXJlKTtcblxuXG5cbiAgY29uc3QgbmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2gxJyk7XG4gIG5hbWUuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5uYW1lO1xuICBsaS5hcHBlbmQobmFtZSk7XG5cbiAgY29uc3QgaXNGYXZvcml0ZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpO1xuICBpc0Zhdm9yaXRlLmlubmVySFRNTCA9ICcmaGVhcnRzOyc7XG4gIGlzRmF2b3JpdGUuY2xhc3NMaXN0LmFkZCgnaXNGYXZvcml0ZScpXG4gIC8vIFNldCBzdHlsZXMgZGVwZW5kaW5nIGlmIGlzIGZhdm9yaXRlIG9yIG5vdFxuICBpZiAocmVzdGF1cmFudC5pc19mYXZvcml0ZSA9PT0gJ3RydWUnIHwgcmVzdGF1cmFudC5pc19mYXZvcml0ZSA9PT0gdHJ1ZSkge1xuICAgIGlzRmF2b3JpdGUuY2xhc3NMaXN0LmFkZCgneWVzRmF2JylcbiAgICBjb25zb2xlLmxvZyhgU3RhdHVzIGZvciAke3Jlc3RhdXJhbnQuaWR9IGlzIHRydWUgYWQgdHlwZSBpcyAke3R5cGVvZihyZXN0YXVyYW50LmlzX2Zhdm9yaXRlKX1gKTtcbiAgfSBlbHNlIGlmKHJlc3RhdXJhbnQuaXNfZmF2b3JpdGUgPT09ICdmYWxzZScgfCByZXN0YXVyYW50LmlzX2Zhdm9yaXRlID09PSBmYWxzZSkge1xuICAgIGlzRmF2b3JpdGUuY2xhc3NMaXN0LnJlbW92ZSgneWVzRmF2JylcbiAgICBjb25zb2xlLmxvZyhgU3RhdHVzIGZvciAke3Jlc3RhdXJhbnQuaWR9IGlzIGZhbHNlIGFkIHR5cGUgaXMgJHt0eXBlb2YocmVzdGF1cmFudC5pc19mYXZvcml0ZSl9YCk7XG4gIH1cblxuICAvLyBVcGRhdGluZyBkYXRhIGJhc2UgYmFzZSBvbiBmYXZvcml0ZSBzdGF0dXNcbiAgaXNGYXZvcml0ZS5vbmNsaWNrID0gKCkgPT4ge1xuICAgIGlzRmF2b3JpdGUuY2xhc3NMaXN0LnRvZ2dsZSgneWVzRmF2JylcbiAgICBjb25zdCBjdXJyZW50RmF2U3RhdHVzID0gIUpTT04ucGFyc2UocmVzdGF1cmFudC5pc19mYXZvcml0ZSk7XG4gICAgY29uc29sZS5sb2coY3VycmVudEZhdlN0YXR1cyk7XG4gICAgdXBkYXRlRmF2b3JpdGVTdGF0dXMocmVzdGF1cmFudC5pZCwgY3VycmVudEZhdlN0YXR1cyk7XG4gICAgcmVzdGF1cmFudC5pc19mYXZvcml0ZSA9IGN1cnJlbnRGYXZTdGF0dXNcbiAgICBjb25zb2xlLmxvZyhyZXN0YXVyYW50LmlzX2Zhdm9yaXRlKTtcbiAgfVxuICBsaS5hcHBlbmQoaXNGYXZvcml0ZSk7XG5cbiAgY29uc3QgbmVpZ2hib3Job29kID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xuICBuZWlnaGJvcmhvb2QuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5uZWlnaGJvcmhvb2Q7XG4gIGxpLmFwcGVuZChuZWlnaGJvcmhvb2QpO1xuXG4gIGNvbnN0IGFkZHJlc3MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XG4gIGFkZHJlc3MuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5hZGRyZXNzO1xuICBsaS5hcHBlbmQoYWRkcmVzcyk7XG5cbiAgY29uc3QgbW9yZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcbiAgbW9yZS5pbm5lckhUTUwgPSAnVmlldyBEZXRhaWxzJztcbiAgbW9yZS5ocmVmID0gREJIZWxwZXIudXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KTtcbiAgbGkuYXBwZW5kKG1vcmUpXG5cbiAgcmV0dXJuIGxpXG59XG5cbi8qKlxuICogQWRkIG1hcmtlcnMgZm9yIGN1cnJlbnQgcmVzdGF1cmFudHMgdG8gdGhlIG1hcC5cbiAqL1xuYWRkTWFya2Vyc1RvTWFwID0gKHJlc3RhdXJhbnRzID0gc2VsZi5yZXN0YXVyYW50cykgPT4ge1xuICByZXN0YXVyYW50cy5mb3JFYWNoKHJlc3RhdXJhbnQgPT4ge1xuICAgIC8vIEFkZCBtYXJrZXIgdG8gdGhlIG1hcFxuICAgIGNvbnN0IG1hcmtlciA9IERCSGVscGVyLm1hcE1hcmtlckZvclJlc3RhdXJhbnQocmVzdGF1cmFudCwgc2VsZi5tYXApO1xuICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG1hcmtlciwgJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBtYXJrZXIudXJsXG4gICAgfSk7XG4gICAgc2VsZi5tYXJrZXJzLnB1c2gobWFya2VyKTtcbiAgfSk7XG59Il19
